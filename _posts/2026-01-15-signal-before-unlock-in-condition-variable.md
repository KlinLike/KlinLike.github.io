---
layout: post
title:  "ðŸŒ±æ¡ä»¶å˜é‡å…ˆ Signal è¿˜æ˜¯å…ˆ Unlockï¼Ÿ"
date:   2026-01-15 20:34:58 +0800
tags: [multithreading, c++, condition-variable, mutex]
---

åœ¨ C/C++ å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œä½¿ç”¨æ¡ä»¶å˜é‡å’Œäº’æ–¥é”çš„æ—¶å€™ï¼Œå…ˆ `unlock` è¿˜æ˜¯å…ˆ `signal`/`notify` éƒ½æ˜¯é€»è¾‘æ­£ç¡®çš„ï¼Œä½†å®žé™…ä¸Šå®ƒä»¬çš„è¡¨çŽ°å­˜åœ¨ç»†å¾®çš„å·®åˆ«ã€‚

## å…ˆ Signalï¼ŒåŽ Unlock

**ä¼˜ç‚¹**ï¼šä¿è¯äº†å‘å‡ºä¿¡å·æ—¶çš„å…±äº«çŠ¶æ€å¤„äºŽé”çš„ä¿æŠ¤ä¸‹ï¼Œä¹Ÿèƒ½é˜²æ­¢çº¿ç¨‹è¢«æŠ¢å ã€‚

**ç¼ºç‚¹**ï¼šè¢«å”¤é†’çš„çº¿ç¨‹åˆšé†’å°±è¦ç­‰å¾…é”ï¼Œé€ æˆé¢å¤–çš„è°ƒåº¦å¼€é”€ã€‚

ä¸è¿‡çŽ°ä»£ Linux å†…æ ¸å¯¹è¿™ç‚¹è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¢žåŠ äº†æ¡ä»¶å˜é‡ç­‰å¾…é˜Ÿåˆ—å’Œäº’æ–¥é‡ç­‰å¾…é˜Ÿåˆ—ï¼Œå”¤é†’åŽçº¿ç¨‹ä¸ä¼šé˜»å¡žç­‰å¾…ï¼Œè€Œæ˜¯ç§»åŠ¨åˆ°ç­‰å¾…äº’æ–¥é‡çš„é˜Ÿåˆ—ï¼Œé¿å…äº†æ€§èƒ½æŸå¤±ã€‚

---

## å…ˆ Unlockï¼ŒåŽ Signal

**ä¼˜ç‚¹**ï¼šå‡å°‘äº†é”çš„ç«žäº‰ï¼Œè¢«å”¤é†’çº¿ç¨‹é†’æ¥æ—¶ï¼Œé”å·²ç»è¢«é‡Šæ”¾ï¼Œå¯ä»¥ç›´æŽ¥èŽ·å–ï¼Œè¿™å¾€å¾€æä¾›äº†æ›´å¥½çš„æ€§èƒ½è¡¨çŽ°ã€‚

**ç¼ºç‚¹**ï¼šåœ¨ `unlock` åˆ° `signal` é—´çš„é—´éš™ï¼Œå¯èƒ½ä¼šæœ‰å…¶ä»–çº¿ç¨‹æŠ¢èµ°é”ã€‚

- æŠ¢èµ°çš„åŽæžœæ˜¯è¢«å”¤é†’çº¿ç¨‹è¿˜æ˜¯é˜»å¡žç­‰å¾…ï¼Œæˆ–è€…æ›´ä¸¥é‡çš„æ˜¯å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†æœ¬åº”è¯¥è¢«å”¤é†’çº¿ç¨‹æ¶ˆè´¹çš„å†…å®¹ã€‚ä¸è¿‡è¿™é‡Œè¦å°å¿ƒä¸€ä¸ªè¯¯åŒºï¼Œå°±æ˜¯å¦‚æžœåˆ«çš„çº¿ç¨‹æ¶ˆè´¹äº†æ•°æ®ï¼Œå°±åº”è¯¥æŠŠ `ready` è®¾ä¸º `false`ï¼Œè¿™æ ·åŽŸæœ¬çš„ç­‰å¾…çº¿ç¨‹ä¸­çš„ `while(ready) cond_wait();` åªæ˜¯ä¼šå†æ¬¡è¿›å…¥ç­‰å¾…ï¼Œé€»è¾‘ä¸Šæ˜¯å¯é çš„

---

## æ€Žä¹ˆé€‰

æ—¢ç„¶æ¯ä¸ªæ–¹æ³•éƒ½æœ‰ä¼˜åŠ£ï¼Œæ ¹æ®ä¸åŒçš„æƒ…å†µå°±ä¼šæœ‰ä¸åŒçš„ç­”æ¡ˆã€‚æ¯”è¾ƒæ ‡å‡†çš„å»ºè®®æ˜¯ï¼š

**å…ˆ Unlock å† Signal** èƒ½æä¾›æ›´å¥½çš„é€šç”¨æ€§èƒ½è¡¨çŽ°ï¼Œä½†å¦‚æžœæ‹…å¿ƒé”è¢«æŠ¢èµ°/é”ä¿æŠ¤çš„æ•°æ®è¢«ä¿®æ”¹ï¼Œå°±åº”è¯¥è€ƒè™‘é€‰æ‹© **å…ˆ Signal å† Unlock**ã€‚ä½†è¦æ³¨æ„åœ¨å¤§å¤šæ•°çŽ°ä»£æ“ä½œç³»ç»Ÿä¸Šï¼Œè¿™ä¸¤ç§æ–¹æ³•çš„æ€§èƒ½å·®å¼‚å¾®ä¹Žå…¶å¾®ï¼Œè€Œå…ˆ Signal æ›´åŠ å®‰å…¨ï¼Œæ‰€ä»¥å…ˆ Signal åº”è¯¥æ˜¯é¦–é€‰ã€‚

ä½†æˆ‘æƒ³ä»Žåº•å±‚åº“è®¾è®¡çš„è§’åº¦æ¥è¯´æ˜Žä¸ºä»€ä¹ˆæ›´åº”è¯¥é€‰æ‹©å…ˆ Signalã€‚

å¯¹åº•å±‚åº“è®¾è®¡è€Œè¨€ï¼Œå®‰å…¨æ˜¯éžå¸¸é‡è¦çš„ï¼Œè€Œå…ˆ Unlock å­˜åœ¨çš„å®‰å…¨éšæ‚£ä¸åªæ˜¯æ•°æ®è¢«ä¸è¯¥æ¶ˆè´¹çš„çº¿ç¨‹æ¶ˆè´¹äº†é‚£ä¹ˆç®€å•ã€‚å‡è®¾è¿™æ ·ä¸€ç§æƒ…å†µï¼š

```cpp
// çº¿ç¨‹ A (Setter/é€šçŸ¥è€…)
void fulfill(Promise* p, int val) {
    pthread_mutex_lock(&p->mtx);
    p->value = val;
    p->ready = true;
    
    pthread_mutex_unlock(&p->mtx); // <--- [æ­¥éª¤ 1] é”é‡Šæ”¾äº†
    
    // --- ç¾éš¾å¯èƒ½å‘ç”Ÿåœ¨è¿™ä¸ªç©ºéš™ ---
    
    pthread_cond_signal(&p->cv);   // <--- [æ­¥éª¤ 3] å°è¯•å‘é€ä¿¡å·
}

// çº¿ç¨‹ B (Waiter/ç­‰å¾…è€…)
void wait_and_destroy(Promise* p) {
    pthread_mutex_lock(&p->mtx);
    while (!p->ready) {
        pthread_cond_wait(&p->cv, &p->mtx);
    }
    pthread_mutex_unlock(&p->mtx);
    
    delete p; // <--- [æ­¥éª¤ 2] é”€æ¯å¯¹è±¡ï¼
}
```

åŽŸå› æ˜¯å¯èƒ½æŸç§åŽŸå› å¯¼è‡´çº¿ç¨‹ B è¢«å”¤é†’äº†ï¼Œæ¯”å¦‚**è™šå‡å”¤é†’**ï¼ˆä¸ºäº†è¿½æ±‚é«˜æ€§èƒ½ï¼Œç³»ç»Ÿå…è®¸ `wait` åœ¨æžå°‘æ•°æƒ…å†µä¸‹å³ä½¿æ²¡æœ‰è¢«å”¤é†’ä¹Ÿè¿”å›žï¼‰ã€‚

å¦‚æžœè¿™ä¸ªæµç¨‹æ¢æˆäº†å…ˆ Signal å† Unlockï¼Œå°±èƒ½ä¿è¯ `pthread_cond_signal`ï¼ˆæ­¥éª¤ 3ï¼‰ä¸€å®šå‘ç”Ÿåœ¨ `delete p`ï¼ˆæ­¥éª¤ 2ï¼‰ä¹‹å‰ã€‚

ä½ å¯ä»¥ç†è§£ä¸ºå…ˆ Signal æ˜¯ä¸€ç§**é˜²å¾¡æ€§ç¼–ç¨‹**çš„ä¹ æƒ¯ï¼Œè¿™å¯¹åº•å±‚åº“çš„ç¨³å®šéžå¸¸é‡è¦ï¼