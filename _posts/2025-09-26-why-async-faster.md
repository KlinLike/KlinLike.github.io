---
layout: post
title:  "ğŸŒ³ä¸ºä»€ä¹ˆå¼‚æ­¥ç¼–ç¨‹æ¯”åŒæ­¥æ›´å¿«ï¼Œè€ŒCPUå®Œæˆçš„å·¥ä½œé‡æ˜¯ä¸€æ ·çš„ï¼Ÿ"
date:   2025-09-26 14:00:54 +0800
tags: [C++, å¼‚æ­¥, Async, ç¼–ç¨‹èŒƒå¼]
---

ç­”æ¡ˆçš„å…³é”®åœ¨äºï¼šå¼‚æ­¥ç¼–ç¨‹å¹¶æ²¡æœ‰å‡å°‘CPUçš„æ€»å·¥ä½œé‡ï¼Œè€Œæ˜¯æé«˜äº†CPUçš„åˆ©ç”¨ç‡ï¼Œæå¤§å‡å°‘äº†â€œç­‰å¾…â€æ—¶é—´ã€‚

# äº‹ä»¶å¾ªç¯

å¤§å¤šæ•°ç°ä»£å¼‚æ­¥æ¡†æ¶éƒ½åŸºäº äº‹ä»¶å¾ªç¯æ¨¡å‹ï¼Œå®ƒçš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š
1. ä»»åŠ¡å…¥é˜Ÿï¼šå½“ä»£ç å‘èµ·ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚æ—¶ï¼ˆå¦‚è¯»å–æ–‡ä»¶ã€å‘é€ç½‘ç»œæ•°æ®ï¼‰ï¼Œæ¡†æ¶ä¼šå°† è¿™ä¸ªä»»åŠ¡ ä»¥åŠ å®Œæˆååº”è¯¥è°ƒç”¨çš„å›è°ƒå‡½æ•° ä¸€å¹¶æäº¤ç»™OSï¼›
2. ç«‹å³è¿”å›ï¼šæäº¤ä¹‹åï¼Œä¸»çº¿ç¨‹ä¸ä¼šç­‰å¾…ç»“æœï¼Œè€Œæ˜¯ç«‹å³è¿”å›ï¼Œç»§ç»­æ‰§è¡Œä¹‹åçš„ä»£ç ï¼›
3. å†…æ ¸å¤„ç†ï¼šæ“ä½œç³»ç»Ÿæ¥ç®¡äº†ä»»åŠ¡ï¼Œå®ƒä¼šç”¨æ›´é«˜æ•ˆçš„æ–¹å¼æ¥å®Œæˆï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç¡¬ä»¶å±‚é¢ç­‰å¾…æ•°æ®å°±ç»ªï¼ˆæ¯”å¦‚æ•°æ®å…¨éƒ½è¯»å–åˆ°ç¼“å†²åŒºåå‘èµ·ä¸­æ–­ï¼‰ï¼Œä¸ç”¨å ç”¨CPUï¼›
4. äº‹ä»¶å¾ªç¯ä¸ä»»åŠ¡é˜Ÿåˆ—ï¼šä¸»çº¿ç¨‹åœ¨æ‰§è¡Œå®ŒåŒæ­¥ä»£ç åï¼Œå°±ä¼šå¼€å§‹è½®è¯¢ä»»åŠ¡é˜Ÿåˆ—ï¼ˆä¹Ÿå°±æ˜¯äº‹ä»¶å¾ªç¯ï¼‰ï¼›
5. å½“OSå®Œæˆäº†æ“ä½œï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªäº‹ä»¶ï¼Œå¹¶å°†ä¸ä¹‹å…³è”çš„å›è°ƒå‡½æ•°æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼›
6. äº‹ä»¶å¾ªç¯å‘ç°ä»»åŠ¡é˜Ÿåˆ—ä¸­æœ‰äº†æ–°ä»»åŠ¡ï¼Œå°±ä¼šå–å‡ºä»»åŠ¡å¹¶æ‰§è¡Œï¼ˆä¹Ÿå°±æ˜¯å°†å›è°ƒå‡½æ•°æ¨å…¥åˆ° è°ƒç”¨æ ˆ æ‰§è¡Œï¼‰ã€‚

ç»“åˆEPOLL + socketæ¥çœ‹å°±æ˜¯ï¼š
1. ä»»åŠ¡å…¥é˜Ÿï¼šepoll_ctl(..., EPOLL_CTL_ADD, socket, ...) *-> å‘Šè¯‰å†…æ ¸ï¼Œè¯·å¸®æˆ‘ç›‘è§†è¿™ä¸ªsocketï¼Œè¯¥å‡½æ•°ç«‹å³è¿”å›ï¼Œä¹Ÿå°±æ˜¯ æ³¨å†Œä»»åŠ¡åä¸ç­‰å¾…*
2. å†…æ ¸å¤„ç†ï¼šå†…æ ¸å¼€å§‹åœ¨åå°ç‹¬ç«‹å·¥ä½œï¼Œç­‰å¾…ç½‘å¡æ•°æ®ã€‚å½“æ•°æ®åˆ°è¾¾æ—¶ï¼Œå†…æ ¸ä¼šå°†å¯¹åº”socketæ ‡è®°ä¸ºå°±ç»ª
3. äº‹ä»¶å¾ªç¯ä¸ä»»åŠ¡é˜Ÿåˆ—ï¼šepoll_wait(...) *-> ä¸»å¾ªç¯é˜»å¡åœ¨è¿™é‡Œï¼Œä½†ä¸æ¶ˆè€—CPUï¼Œè€Œæ˜¯ç¡çœ ï¼Œå¹¶ä¸”ç­‰å¾…å†…æ ¸çš„å”¤é†’é€šçŸ¥*
4. ä¸€æ—¦socketå°±ç»ªï¼Œepoll_waitå°±ä¼šè¢«å”¤é†’å¹¶è¿”å›ï¼ŒåŒæ—¶å‘Šè¯‰ç¨‹åºé‚£äº›socketå·²ç»å°±ç»ªï¼ˆè¿™é‡Œå¯¹åº”çš„æ˜¯ä¸Šé¢çš„5.6.ä¸¤æ­¥ï¼Œå–å‡ºä»»åŠ¡å¹¶æ‰§è¡Œï¼Œä»»åŠ¡å°±æ˜¯å”¤é†’epoll_waitï¼‰
5. ç¨‹åºå¾—çŸ¥socketçŠ¶æ€åï¼Œç»§ç»­æ‰§è¡Œ

é€šè¿‡è¿™ä¸ªæœºåˆ¶ï¼Œåœ¨ç†æ€§æƒ…å†µä¸‹ï¼ŒCPUæ°¸è¿œåœ¨åšæœ‰æ„ä¹‰çš„äº‹æƒ…ï¼šè¦ä¹ˆæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œè¦ä¹ˆä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºå¼‚æ­¥ä»»åŠ¡è¿›è¡Œåç»­å¤„ç†ã€‚

# Qtçš„äº‹ä»¶æ¨¡å‹

Qtçš„æ¡†æ¶è®¾è®¡éå¸¸ä¼˜ç§€ï¼Œå…¶äº‹ä»¶æ¨¡å‹æ˜¯æ•™ç§‘ä¹¦çº§åˆ«çš„Reactorå®ç°ã€‚

å¯¹GUIæ¡†æ¶è€Œè¨€ï¼Œæœ‰ä¸€ä¸ªä¼˜å…ˆçº§æ›´é«˜çš„é—®é¢˜ï¼šä¸»çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯GUIçº¿ç¨‹ï¼Œç»å¯¹ä¸èƒ½è¢«é˜»å¡ã€‚ä¸€æ—¦è¢«é˜»å¡ï¼Œç”¨æˆ·ç•Œé¢å°±ä¼šå¤±å»å“åº”ï¼Œä½“éªŒæå·®ã€‚

æœ‰å…³çš„æ ¸å¿ƒç»„ä»¶ï¼š
- QApplication/QCoreApplicationï¼šæ˜¯åº”ç”¨ç¨‹åºçš„ç®¡ç†è€…ï¼Œå®ƒæ‹¥æœ‰å¹¶è´Ÿè´£å¯åŠ¨äº‹ä»¶å¾ªç¯ï¼›
- äº‹ä»¶é˜Ÿåˆ—ï¼šä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜æ”¾æ‰€æœ‰å¾…å¤„ç†çš„QEventå¯¹è±¡ï¼›
- QEventï¼šä¸€ä¸ªäº‹ä»¶çš„è¡¨ç¤ºï¼Œæ— è®ºæ˜¯ç”¨æˆ·çš„è¾“å…¥ï¼ˆé¼ æ ‡ã€é”®ç›˜ï¼‰ï¼Œè¿˜æ˜¯ç³»ç»Ÿå†…éƒ¨çš„å®šæ—¶å™¨è¶…æ—¶ï¼Œçª—å£é‡ç»˜è¯·æ±‚ï¼Œéƒ½ä¼šè¢«å°è£…æˆä¸€ä¸ªQEventå¯¹è±¡;
- QObject:Qtä¸­ç»å¤§å¤šæ•°ç±»çš„åŸºç±»ï¼Œå…·å¤‡æ¥å—å’Œå¤„ç†äº‹ä»¶çš„èƒ½åŠ›ã€‚

å·¥ä½œæµç¨‹ï¼š
0. ç¨‹åºå¯åŠ¨å¹¶è°ƒç”¨app.exec()ï¼Œäº‹ä»¶å¾ªç¯å¼€å§‹ï¼›
1. å¾ªç¯é¦–å…ˆæ£€æŸ¥äº‹ä»¶é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼›
2. å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œäº‹ä»¶å¾ªç¯ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œå°†CPUæ§åˆ¶æƒäº¤è¿˜ç»™æ“ä½œç³»ç»Ÿï¼›
3. å½“æ“ä½œç³»ç»Ÿæˆ–Qtå†…éƒ¨äº§ç”Ÿæ–°çš„äº‹ä»¶æ—¶ï¼Œäº‹ä»¶å¾ªç¯è¢«å”¤é†’ï¼›
4. äº‹ä»¶å¾ªç¯ä»é˜Ÿåˆ—å¤´éƒ¨å–å‡ºäº‹ä»¶ï¼ˆæ–°äº‹ä»¶ä¼šè¢«å°è£…æˆQEventå¯¹è±¡å¹¶æ·»åŠ åˆ°äº‹ä»¶é˜Ÿåˆ—æœ«å°¾ï¼‰ï¼Œå®ƒä¼šè¯†åˆ«äº‹ä»¶çš„ç›®æ ‡æ¥å—è€…ï¼ˆä¸€ä¸ªQObjectå¯¹è±¡ï¼‰å¹¶è°ƒç”¨å¯¹è±¡çš„.event()æ–¹æ³•ï¼ŒåŒæ—¶å°†äº‹ä»¶å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’è¿‡å»ï¼›
5. .event()æ–¹æ³•ä¼šæ ¹æ®äº‹ä»¶çš„å…·ä½“ç±»å‹ï¼Œè°ƒç”¨å¯¹åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œå¦‚mousePressEvent()\keyPressEvent();
6. ä¸€ä¸ªeventå¤„ç†å®Œæ¯•åï¼Œå¾ªç¯ç«‹å³å›åˆ°ç¬¬ä¸€æ­¥ï¼ˆæ£€æŸ¥ä¸‹ä¸ªäº‹ä»¶ï¼‰ï¼›
7. æŒç»­1-6ç›´åˆ°æ¥æ”¶åˆ°é€€å‡ºæ—¶é—´ï¼Œç„¶åapp.exec()è¿”å›ã€‚

*-> è¿™é‡Œçš„ç¬¬ä¸‰æ­¥å’Œå‰é¢çš„ç¬¬å››æ­¥éƒ½æ¶‰åŠå”¤é†’ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼šOSå’ŒAppä¹‹é—´æ˜¯æœ‰éš”ç¦»çš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ å†…æ ¸ç©ºé—´ å’Œ ç”¨æˆ·ç©ºé—´ã€‚å†…æ ¸ç©ºé—´é€šå¸¸ä¸ä¼šç›´æ¥è°ƒç”¨ä¸€ä¸ªç”¨æˆ·ç©ºé—´å‡½æ•°ï¼Œå› ä¸ºè¿™ä¼šæœ‰å¾ˆå¤§çš„é£é™©ã€‚æ‰€ä»¥å”¤é†’å¹¶ä¸æ˜¯é€šè¿‡OSç›´æ¥è°ƒç”¨ ç”¨æˆ·ç©ºé—´å†…çš„æŸä¸ªå›è°ƒå‡½æ•°å®ç°çš„ï¼Œè€Œæ˜¯é€šè¿‡å†…æ ¸å”¤é†’è¿›ç¨‹å®ç°çš„ã€‚*

ä¿¡å·æ§½ï¼š
ä¿¡å·æ§½æ˜¯å»ºç«‹åœ¨äº‹ä»¶å¾ªç¯ä¸Šçš„æŠ½è±¡ï¼Œå®ƒç®€åŒ–äº†å¯¹è±¡é—´çš„é€šä¿¡ã€‚
è¿™ç§ä¼˜åŠ¿åœ¨ä¸åŒçº¿ç¨‹çš„å¯¹è±¡é—´é€šä¿¡ä¸­å±•ç°å¾—å°¤å…¶æ˜æ˜¾ï¼šå½“ä¸€ä¸ªä¿¡å·é€šè¿‡é˜Ÿåˆ—è¿æ¥å‘å°„åˆ°ä¸€ä¸ªä½äºå¦ä¸€çº¿ç¨‹çš„æ§½æ—¶ï¼Œç³»ç»Ÿå¹¶ä¸ä¼šç›´æ¥è°ƒç”¨è¯¥æ§½å‡½æ•°ã€‚ç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªQEventï¼Œå…¶å†…éƒ¨åŒ…å«äº†è¦æ‰§è¡Œçš„æ§½å‡½æ•°åŠå…¶å‚æ•°ï¼Œéšåå°†è¿™ä¸ªQEventæŠ•é€’åˆ°æ¥æ”¶è€…å¯¹è±¡æ‰€åœ¨çº¿ç¨‹çš„äº‹ä»¶é˜Ÿåˆ—ä¸­ã€‚æœ€ç»ˆæ¥å—è€…çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯ä¼šå–å‡ºè¿™ä¸ªQEventå¹¶æ‰§è¡Œå¯¹åº”çš„æ§½å‡½æ•°ã€‚

*-> app.exec()åªè´Ÿè´£å¯åŠ¨ä¸»çº¿ç¨‹ï¼ˆä¹Ÿå°±æ˜¯GUIçº¿ç¨‹ï¼‰çš„äº‹ä»¶å¾ªç¯ã€‚å¯¹äºå…¶ä»–çš„å·¥ä½œçº¿ç¨‹ï¼Œå¦‚æœå®ƒä»¬ä¹Ÿéœ€è¦å¤„ç†äº‹ä»¶ï¼Œåˆ™å¿…é¡»åœ¨çº¿ç¨‹å†…éƒ¨æ‰‹åŠ¨å¯ç”¨ä¸€ä¸ªå±äºä»–è‡ªå·±çš„äº‹ä»¶å¾ªç¯ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢è¯´æ¯ä¸ªçº¿ç¨‹è‡ªå·±çš„äº‹ä»¶å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯â€œäº‹ä»¶å¾ªç¯ä¸æ˜¯å”¯ä¸€çš„ï¼Œè€Œæ˜¯ä¸çº¿ç¨‹ç»‘å®šçš„â€ã€‚*

# è®¾è®¡æ¨¡å¼çš„å˜è¿

æˆ‘ä»¬ç”¨åˆ¶ä½œä¸€æ¯å’–å•¡è¿‡ç¨‹æ¥ä¸¾ä¾‹ï¼š
1. ç£¨å’–å•¡è±† (è€—æ—¶2ç§’)
2. ç”¨ç£¨å¥½çš„å’–å•¡ç²‰ èƒå–æµ“ç¼©å’–å•¡ (è€—æ—¶3ç§’)
3. æ‰“å‘ç‰›å¥¶ åˆ¶ä½œå¥¶æ³¡ (è€—æ—¶4ç§’)
4. å°†æµ“ç¼©å’–å•¡å’Œå¥¶æ³¡æ··åˆï¼Œå†åŠ å…¥å·§å…‹åŠ›é…±ï¼Œåˆ¶æˆæ‘©å¡ (è€—æ—¶1ç§’)
æ¯ä¸ªæ­¥éª¤éƒ½ä¾èµ–äºå‰ä¸€ä¸ªæ­¥éª¤çš„å®Œæˆã€‚

ä¸‹é¢æ˜¯ç¤ºä¾‹ä»£ç çš„åŸºç¡€éƒ¨åˆ†(cpp)ï¼š
```
#include <iostream>
#include <string>
#include <thread>
#include <chrono>
#include <functional>
#include <future>

// æ¨¡æ‹Ÿä¸€ä¸ªéœ€è¦ä¸€å®šæ—¶é—´æ‰èƒ½å®Œæˆçš„æ“ä½œ
void simulate_work(int ms) {
    std::this_thread::sleep_for(std::chrono::milliseconds(ms));
}

// å’–å•¡åˆ¶ä½œçš„å„ä¸ªæ­¥éª¤çš„äº§å‡ºå“
struct Grounds { std::string value = "å’–å•¡ç²‰"; };
struct Espresso { std::string value = "æµ“ç¼©å’–å•¡"; };
struct MilkFoam { std::string value = "å¥¶æ³¡"; };
struct Mocha { std::string value = "ä¸€æ¯é¦™æµ“çš„æ‘©å¡"; };
```

# é˜¶æ®µ1ï¼šå›è°ƒå‡½æ•° Callback
å›è°ƒå‡½æ•°æ˜¯æœ€åŸå§‹ã€æœ€ç›´æ¥çš„å¼‚æ­¥å¤„ç†æ–¹å¼ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå½“ä½ æ˜¨æ™šè¿™ä»¶äº‹åï¼Œè¯·è°ƒç”¨æˆ‘ç»™ä½ çš„è¿™ä¸ªå‡½æ•°ã€‚

ç”¨åˆ¶ä½œå’–å•¡çš„è¿‡ç¨‹ä¸¾ä¾‹å°±æ˜¯ï¼š
ç£¨å®Œè±†å­ä¹‹åï¼Œè°ƒç”¨èƒå–å‡½æ•°ï¼Œèƒå–å®Œæˆåï¼Œè°ƒç”¨åˆ¶ä½œå¥¶æ³¡å‡½æ•°ï¼Œæœ€åè°ƒç”¨æ··åˆå‡½æ•°ã€‚

ç”¨å»å¿«é¤åº—ç‚¹é¤ä¸¾ä¾‹å°±æ˜¯ï¼š
ä½ å»ç‚¹é¤ï¼Œç•™ä¸‹ç”µè¯ï¼Œè€æ¿ä¼šåœ¨åšå¥½åæ‰“ä½ ç”µè¯ã€‚

è¿™ä¸ªæ¨¡å¼çš„ç—›ç‚¹æ˜¾è€Œæ˜“è§ï¼š
1. å›è°ƒåœ°ç‹±ï¼šä»£ç æ— é™å»¶ä¼¸ï¼Œå½¢æˆä¸€ä¸ªéš¾ä»¥é˜…è¯»å’Œç»´æŠ¤çš„åµŒå¥—ç»“æ„ï¼›
2. æ§åˆ¶åè½¬ï¼šæˆ‘ä»¬å¤±å»äº†å¯¹æµç¨‹çš„ç›´æ¥æ§åˆ¶ï¼Œå°†ç¨‹åºçš„ä¸‹ä¸€æ­¥æ‰§è¡Œæƒå®Œå…¨äº¤ç»™äº†ç¬¬ä¸‰æ–¹å‡½æ•°ã€‚å¦‚æœç¬¬ä¸‰æ–¹å‡½æ•°æœ‰bugï¼Œç¨‹åºå°±ä¼šå‡ºé—®é¢˜ã€‚
3. æ¯ä¸ªç¬¬ä¸‰æ–¹å‡½æ•°éƒ½éœ€è¦å®ç°è‡ªå·±çš„é”™è¯¯å¤„ç†ï¼Œç¹çä¸”å†—ä½™

å›è°ƒåœ°ç‹±çš„ç¤ºä¾‹ä»£ç ï¼š
```
// 1. ç£¨å’–å•¡è±† (å¼‚æ­¥)
void grindBeans_cb(std::function<void(Grounds)> callback) {
    std::thread([=]() {
        std::cout << "1. å¼€å§‹ç£¨å’–å•¡è±†...\n";
        simulate_work(1000);
        Grounds grounds;
        std::cout << "1. å’–å•¡è±†ç£¨å¥½äº† -> " << grounds.value << "\n";
        callback(grounds); // å®Œæˆåï¼Œè°ƒç”¨ä¼ å…¥çš„å›è°ƒå‡½æ•°
    }).detach();
}

// 2. èƒå–æµ“ç¼©å’–å•¡ (å¼‚æ­¥)
void brewEspresso_cb(const Grounds& grounds, std::function<void(Espresso)> callback) {
    std::thread([=]() {
        std::cout << "2. å¼€å§‹ç”¨'" << grounds.value << "'èƒå–æµ“ç¼©å’–å•¡...\n";
        simulate_work(1500);
        Espresso espresso;
        std::cout << "2. æµ“ç¼©å’–å•¡åšå¥½äº† -> " << espresso.value << "\n";
        callback(espresso);
    }).detach();
}

// 3. åˆ¶ä½œå¥¶æ³¡ (å¼‚æ­¥)
void frothMilk_cb(std::function<void(MilkFoam)> callback) {
    std::thread([=]() {
        std::cout << "3. å¼€å§‹åˆ¶ä½œå¥¶æ³¡...\n";
        simulate_work(2000);
        MilkFoam foam;
        std::cout << "3. å¥¶æ³¡åšå¥½äº† -> " << foam.value << "\n";
        callback(foam);
    }).detach();
}

// 4. æ··åˆåˆ¶ä½œæ‘©å¡ (å¼‚æ­¥)
void makeMocha_cb(const Espresso& e, const MilkFoam& f, std::function<void(Mocha)> callback) {
    std::thread([=]() {
        std::cout << "4. å¼€å§‹æ··åˆ " << e.value << " å’Œ " << f.value << "...\n";
        simulate_work(500);
        Mocha mocha;
        std::cout << "4. æ‘©å¡åšå¥½äº†!\n";
        callback(mocha);
    }).detach();
}


// å›è°ƒåœ°ç‹±!!!
void run_callback_example() {
    std::cout << "\n--- é˜¶æ®µ1: å›è°ƒå‡½æ•°ç¤ºä¾‹ ---\n";
    
    // ä½¿ç”¨åµŒå¥—çš„Lambdaè¡¨è¾¾å¼æ¥ç¼–æ’æµç¨‹
    grindBeans_cb([](Grounds grounds) {
        brewEspresso_cb(grounds, [](Espresso espresso) {
            frothMilk_cb([=](MilkFoam foam) { // espressoéœ€è¦æ•è·
                makeMocha_cb(espresso, foam, [](Mocha mocha) {
                    std::cout << ">>> æœ€ç»ˆæˆå“: " << mocha.value << std::endl;
                });
            });
        });
    });

    // ä¸»çº¿ç¨‹éœ€è¦ç­‰å¾…ï¼Œå¦åˆ™ç¨‹åºä¼šç›´æ¥é€€å‡º
    std::this_thread::sleep_for(std::chrono::seconds(6));
}
```

# é˜¶æ®µ2ï¼šPromise
Promiseæ¨¡å¼å¼•å…¥äº†ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼šä¸€ä¸ªä»£è¡¨äº†æœªæ¥ç»“æœçš„å¯¹è±¡ã€‚

ç”¨å»å¿«é¤åº—ç‚¹é¤ä¸¾ä¾‹å°±æ˜¯ï¼š
ä½ å»ç‚¹é¤ï¼Œä¸ç”¨ç•™ä¸‹ç”µè¯ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ç»™ä½ ä¸€ä¸ªå«å·å™¨ï¼ˆPromiseå¯¹è±¡ï¼‰ã€‚å«å·å™¨æœ‰å‡ ç§çŠ¶æ€ï¼š
- pending,è¿›è¡Œä¸­ï¼šå¨æˆ¿æ­£åœ¨åšï¼›
- fulfilled,å·²æˆåŠŸï¼šå«å·å™¨æŒ¯åŠ¨ï¼Œå¯ä»¥å–é¤äº†ï¼›
- rejected,å¤±è´¥ï¼šæŒ‡ç¤ºå™¨æ˜¾ç¤ºå·ç å–æ¶ˆï¼Œå¯èƒ½æ˜¯é£Ÿææ²¡äº†ã€‚

è¿™é‡Œçš„å…³é”®åœ¨äºï¼Œæ§åˆ¶æƒå›åˆ°äº†ä½ çš„æ‰‹ä¸Šã€‚ä½ å¯ä»¥å†³å®šä»€ä¹ˆæ—¶å€™æŸ¥çœ‹å«å·å™¨ï¼Œä¹Ÿå¯ä»¥å†³å®šåšå¥½ä¹‹åè¦æ€ä¹ˆåšï¼ˆæ¯”å¦‚å…ˆæ”¾ä¸€ä¼šç­‰ä½ å®Œæˆæ‰‹å¤´çš„äº‹æƒ…å†å»å–é¤ï¼Œå› ä¸ºä½ æœ‰å–é¤å‡­è¯â€”â€”å«å·å™¨ï¼‰ã€‚

Promiseå¸¦æ¥çš„å·¨å¤§è¿›æ­¥ï¼š
1. é€šè¿‡é“¾å¼è°ƒç”¨ï¼Œå°†é‡‘å­—å¡”ç»“æ„æ‹‰å¹³æˆäº†çº¿æ€§çš„æµç¨‹ï¼Œä»£ç å¯è¯»æ€§å¤§å¤§å¢å¼ºï¼›
2. æ§åˆ¶æƒå›å½’ï¼›
3. ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ï¼›
4. å¯ä»¥ç»„åˆå¤šä¸ªPromiseï¼Œç®€åŒ–äº†å¤æ‚ä»»åŠ¡çš„å¤„ç†ã€‚

Promiseæ¨¡å¼çš„ç¤ºä¾‹ä»£ç (cppä¸­ç”¨promise&futureå®ç°)ï¼š

```
// 1. ç£¨å’–å•¡è±† (è¿”å› future)
std::future<Grounds> grindBeans_promise() {
    std::promise<Grounds> p;
    std::future<Grounds> f = p.get_future();

    std::thread([p = std::move(p)]() {
        std::cout << "1. å¼€å§‹ç£¨å’–å•¡è±†...\n";
        simulate_work(1000);
        Grounds grounds;
        std::cout << "1. å’–å•¡è±†ç£¨å¥½äº† -> " << grounds.value << "\n";
        p.set_value(grounds);
    }).detach();
    
    return f;
}

// 2. èƒå–æµ“ç¼©å’–å•¡ (æ¥æ”¶ futureï¼Œè¿”å› future)
std::future<Espresso> brewEspresso_promise(std::future<Grounds> grounds_f) {
    std::promise<Espresso> p;
    std::future<Espresso> f = p.get_future();

    std::thread([p = std::move(p), grounds_f = std::move(grounds_f)]() {
        Grounds grounds = grounds_f.get(); 
        std::cout << "2. å¼€å§‹ç”¨'" << grounds.value << "'èƒå–æµ“ç¼©å’–å•¡...\n";
        simulate_work(1500);
        Espresso espresso;
        std::cout << "2. æµ“ç¼©å’–å•¡åšå¥½äº† -> " << espresso.value << "\n";
        p.set_value(espresso);
    }).detach();

    return f;
}

// 3. åˆ¶ä½œå¥¶æ³¡ (è¿”å› future)
std::future<MilkFoam> frothMilk_promise() {
    std::promise<MilkFoam> p;
    std::future<MilkFoam> f = p.get_future();

    std::thread([p = std::move(p)](){
        std::cout << "3. å¼€å§‹åˆ¶ä½œå¥¶æ³¡...\n";
        simulate_work(2000);
        MilkFoam foam;
        std::cout << "3. å¥¶æ³¡åšå¥½äº† -> " << foam.value << "\n";
        p.set_value(foam);
    }).detach();

    return f;
}

// 4. æ··åˆåˆ¶ä½œæ‘©å¡ (æ¥æ”¶ futures, è¿”å› future)
std::future<Mocha> makeMocha_promise(std::future<Espresso> e_f, std::future<MilkFoam> f_f) {
     std::promise<Mocha> p;
     std::future<Mocha> mocha_f = p.get_future();

     std::thread([p = std::move(p), e_f = std::move(e_f), f_f = std::move(f_f)](){
        Espresso e = e_f.get();
        MilkFoam f = f_f.get();
        std::cout << "4. å¼€å§‹æ··åˆ " << e.value << " å’Œ " << f.value << "...\n";
        simulate_work(500);
        Mocha mocha;
        std::cout << "4. æ‘©å¡åšå¥½äº†!\n";
        p.set_value(mocha);
     }).detach();

     return mocha_f;
}

void run_promise_example() {    
    // å¯åŠ¨å¹¶è¡Œä»»åŠ¡
    std::future<Grounds> grounds_f = grindBeans_promise();
    std::future<MilkFoam> milk_f = frothMilk_promise(); // åˆ¶ä½œå¥¶æ³¡å¯ä»¥å’Œç£¨è±†ã€èƒå–å¹¶è¡Œ

    // ç¼–æ’ä¾èµ–å…³ç³»
    std::future<Espresso> espresso_f = brewEspresso_promise(std::move(grounds_f));
    std::future<Mocha> mocha_f = makeMocha_promise(std::move(espresso_f), std::move(milk_f));
    
    // åœ¨ä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…æœ€ç»ˆç»“æœ
    try {
        Mocha final_mocha = mocha_f.get();
        std::cout << ">>> æœ€ç»ˆæˆå“: " << final_mocha.value << std::endl;
    } catch (const std::exception& e) {
        std::cerr << "åˆ¶ä½œè¿‡ç¨‹ä¸­å‡ºé”™: " << e.what() << '\n';
    }
}
```
*-> std::promise & futureæ˜¯æ— æ³•è¢«å¤åˆ¶çš„ï¼Œæ‰€ä»¥éœ€è¦ç”¨std::move*


# é˜¶æ®µ3ï¼šAsync/Await
Promiseçš„è°ƒç”¨é“¾åœ¨é€»è¾‘éå¸¸å¤æ‚æ—¶ï¼Œä»ç„¶ä¼šæ˜¾å¾—å†—é•¿ã€‚Async/Awaitå¹¶éå‘æ˜äº†æ–°çš„åº•å±‚æœºåˆ¶ï¼Œè€Œæ˜¯ç»™Promiseæ¨¡å¼æä¾›äº†ä¸€å±‚è¯­æ³•ç³–ã€‚
async/awaitæ¨¡å¼çš„æœ¬è´¨ï¼Œæ˜¯ä¸€ç§éšœçœ¼æ³•ï¼Œå®ƒå…è®¸æˆ‘ä»¬ç”¨å†™åŒæ­¥ä»£ç çš„é€»è¾‘å’Œé¡ºåºï¼Œæ¥æè¿°å’Œæ§åˆ¶å®Œå…¨å¼‚æ­¥ã€éé˜»å¡çš„æ‰§è¡Œæµç¨‹ã€‚


ç”¨å»å¿«é¤åº—ç‚¹é¤ä¸¾ä¾‹å°±æ˜¯ï¼š
ä½ ä¸ç”¨å†äº²è‡ªç­‰å«å·å™¨ï¼Œè€Œæ˜¯ç›´æ¥å‘Šè¯‰ä½ çš„åŠ©æ‰‹ï¼šç­‰é¤å“å‡†å¤‡å¥½åï¼Œé€åˆ°æˆ‘çš„æ¡Œå­ä¸Šã€‚

è¿™ä¸ªä¾‹å­å¯èƒ½ä¸å¤ªæ˜æ˜¾ï¼Œä¸‹é¢ç”¨åˆ¶ä½œå’–å•¡æ¥ä¸¾ä¾‹ï¼ˆè¿™ä¸ªåŠ©ç†å®é™…ä¸Šæ˜¯è°ƒåº¦ç¨‹åºï¼‰ï¼š
ä½ ä¸å†éœ€è¦äº²è‡ªç­‰å«å·å™¨ï¼Œè€Œæ˜¯ç›´æ¥å‘Šè¯‰ä½ çš„åŠ©ç†ï¼š
1. ç­‰å¾… (await) å’–å•¡è±†ç£¨å¥½
2. ç„¶åï¼Œç­‰å¾… (await) ç”¨å®ƒèƒå–å‡ºæµ“ç¼©å’–å•¡
3. åŒæ—¶ï¼Œç­‰å¾… (await) ç‰›å¥¶æ‰“å‘å¥½
4. æœ€åï¼Œç­‰å¾… (await) å®ƒä»¬æ··åˆæˆæ‘©å¡

ä½ å¯ä»¥å†™å‡ºæ›´ç¬¦åˆäººç±»ç›´è§‰çš„ä»£ç ï¼ŒåŠ©ç†è¿™ä¼šåœ¨ç­‰å¾…çš„é—´éš™å¤„ç†å…¶ä»–äº‹æƒ…ï¼ˆæ¯”å¦‚äº‹ä»¶å¾ªç¯ï¼‰ï¼Œå¹¶åœ¨ä»»åŠ¡å®Œæˆåå›æ¥ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚

Async/Awaitçš„ä¼˜åŠ¿ï¼š
1. å¯è¯»æ€§æå¼ºï¼›
2. é”™è¯¯å¤„ç†æ›´åŠ è‡ªç„¶ï¼›
3. è°ƒè¯•æ›´åŠ æ–¹ä¾¿ï¼Œä¸åƒè°ƒè¯•Promiseé“¾é‚£æ ·å›°éš¾ã€‚


Async/Awaitçš„ç¤ºä¾‹ä»£ç ï¼š
*-> åŸºäºASIOçš„åç¨‹æ¨¡å¼ï¼Œä½“ç°äº† async/await è¿™ç§è®¾è®¡æ€æƒ³ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨ASIOè€Œä¸æ˜¯C++æ ‡å‡†åº“ï¼Œæ˜¯å› ä¸ºæ²¡æœ‰å‘ç°æ ‡å‡†åº“èƒ½ç”¨åŒæ ·ä¼˜é›…æ–¹å¼å®ç°çš„æ–¹æ³•ã€‚*
```	
#include <iostream>
#include <string>
#include <chrono>
#include <asio.hpp>
#include <asio/co_spawn.hpp>
#include <asio/detached.hpp>
#include <asio/steady_timer.hpp>


// ä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¸¦çº¿ç¨‹IDçš„æ‰“å°å‡½æ•°
void print(const std::string& msg) {
    std::cout << "[Thread " << std::this_thread::get_id() << "] " << msg << std::endl;
}

struct Grounds { std::string value = "å’–å•¡ç²‰"; };
struct Espresso { std::string value = "æµ“ç¼©å’–å•¡"; };
struct MilkFoam { std::string value = "å¥¶æ³¡"; };
struct Mocha { std::string value = "ä¸€æ¯é¦™æµ“çš„æ‘©å¡"; };


// æ‰€æœ‰å¼‚æ­¥å‡½æ•°ç°åœ¨è¿”å› asio::awaitable<T>ï¼Œè¿™æ˜¯ Asio åŸç”Ÿæ”¯æŒåç¨‹çš„ç±»å‹

// 1. ç£¨å’–å•¡è±†
asio::awaitable<Grounds> grindBeans_asio() {
    print("1. å¼€å§‹ç£¨å’–å•¡è±†...");
    
    // è·å–å½“å‰åç¨‹çš„æ‰§è¡Œå™¨(executor)æ¥åˆ›å»ºå®šæ—¶å™¨
    auto executor = co_await asio::this_coro::executor;
    asio::steady_timer timer(executor, std::chrono::seconds(1));
    
    // co_await ä¸€ä¸ªåŸç”Ÿçš„ asio å¼‚æ­¥æ“ä½œ
    co_await timer.async_wait(asio::use_awaitable);
    
    Grounds grounds;
    print("1. å’–å•¡è±†ç£¨å¥½äº† -> " + grounds.value);
    co_return grounds;
}

// 2. èƒå–æµ“ç¼©å’–å•¡
asio::awaitable<Espresso> brewEspresso_asio(const Grounds& grounds) {
    print("2. å¼€å§‹ç”¨'" + grounds.value + "'èƒå–æµ“ç¼©å’–å•¡...");
    auto executor = co_await asio::this_coro::executor;
    asio::steady_timer timer(executor, std::chrono::seconds(2));
    co_await timer.async_wait(asio::use_awaitable);
    
    Espresso espresso;
    print("2. æµ“ç¼©å’–å•¡åšå¥½äº† -> " + espresso.value);
    co_return espresso;
}

// 3. åˆ¶ä½œå¥¶æ³¡
asio::awaitable<MilkFoam> frothMilk_asio() {
    print("3. å¼€å§‹åˆ¶ä½œå¥¶æ³¡...");
    auto executor = co_await asio::this_coro::executor;
    asio::steady_timer timer(executor, std::chrono::seconds(1));
    co_await timer.async_wait(asio::use_awaitable);

    MilkFoam foam;
    print("3. å¥¶æ³¡åšå¥½äº† -> " + foam.value);
    co_return foam;
}

// 4. æ··åˆåˆ¶ä½œæ‘©å¡
asio::awaitable<Mocha> makeMocha_asio(const Espresso& e, const MilkFoam& f) {
    print("4. å¼€å§‹æ··åˆ " + e.value + " å’Œ " + f.value + "...");
    auto executor = co_await asio::this_coro::executor;
    asio::steady_timer timer(executor, std::chrono::milliseconds(500));
    co_await timer.async_wait(asio::use_awaitable);

    Mocha mocha;
    print("4. æ‘©å¡åšå¥½äº†!");
    co_return mocha;
}

// é¡¶å±‚çš„å·¥ä½œæµåç¨‹
asio::awaitable<void> makeMochaWorkflow() {
    print("--- Asio åç¨‹å·¥ä½œæµå¼€å§‹ ---");

    // 1. å¹¶è¡Œå¯åŠ¨ä¸¤ä¸ªä¸ç›¸å¹²çš„ä»»åŠ¡
    // co_spawn ä¼šç«‹å³å¼€å§‹æ‰§è¡Œè¿™ä¸¤ä¸ªåç¨‹ï¼Œå¹¶è¿”å›ä¸€ä¸ª awaitable å¯¹è±¡
    auto grounds_task = asio::co_spawn(co_await asio::this_coro::executor, grindBeans_asio(), asio::use_awaitable);
    auto milk_task = asio::co_spawn(co_await asio::this_coro::executor, frothMilk_asio(), asio::use_awaitable);

    // 2. ç­‰å¾…ç£¨è±†ä»»åŠ¡å®Œæˆï¼Œå› ä¸ºä¸‹ä¸€æ­¥ä¾èµ–å®ƒ
    auto grounds = co_await grounds_task;

    // 3. å¼€å§‹èƒå–ä»»åŠ¡
    auto espresso = co_await brewEspresso_asio(grounds);

    // 4. ç­‰å¾…æ‰“å¥¶æ³¡ä»»åŠ¡å®Œæˆ
    auto foam = co_await milk_task;

    // 5. æ··åˆå¹¶ç­‰å¾…æœ€ç»ˆç»“æœ
    auto final_mocha = co_await makeMocha_asio(espresso, foam);

    print(">>> æœ€ç»ˆæˆå“: " + final_mocha.value);
    print("--- Asio åç¨‹å·¥ä½œæµç»“æŸ ---");
}


int main() {
    // 1. åˆ›å»º Asio çš„æ ¸å¿ƒ io_contextï¼Œå®ƒæ‰®æ¼”äº†äº‹ä»¶å¾ªç¯è°ƒåº¦å™¨çš„è§’è‰²
    asio::io_context ctx;

    // 2. ä½¿ç”¨ co_spawn å°†æˆ‘ä»¬çš„é¡¶å±‚åç¨‹ä»»åŠ¡â€œæ‰”â€åˆ° io_context ä¸Šå»æ‰§è¡Œ
    //    asio::detached è¡¨ç¤ºæˆ‘ä»¬â€œå‘å°„åä¸ç®¡â€ï¼Œä¸åœ¨è¿™é‡Œç­‰å¾…å®ƒçš„ç»“æœ
    asio::co_spawn(ctx, makeMochaWorkflow(), asio::detached);

    // 3. è¿è¡Œ io_context çš„äº‹ä»¶å¾ªç¯ã€‚
    //    å®ƒä¼šæ‰§è¡Œæ‰€æœ‰å¼‚æ­¥ä»»åŠ¡ï¼Œç›´åˆ°æ²¡æœ‰ä»»åŠ¡å¯åšæ—¶æ‰ä¼šè¿”å›ã€‚
    print("Asio äº‹ä»¶å¾ªç¯å¼€å§‹è¿è¡Œ...");
    ctx.run();
    print("Asio äº‹ä»¶å¾ªç¯ç»“æŸã€‚");

    return 0;
}
```


