---
title:  "ğŸŒ³å­¦ä¹ åç¨‹å°è®° (ucontext)"
date: 2025-06-07T20:53:14+08:00
tags: [coroutine, ucontext, concurrency, cpp]
---

# ucontextçš„ä¸»è¦ç±»å‹ã€å‡½æ•°åŠå…¶ç”¨æ³•
## 1. å®šä¹‰ä¸Šä¸‹å˜é‡ -> ucontext_t ç±»å‹
```
ucontext_t main_ctx;  // ä¸ºä¸»æµç¨‹å®šä¹‰
ucontext_t ctx[3];        // ä¸ºåç¨‹å®šä¹‰
```

## 2. åˆ†é…æ ˆç©ºé—´
æ¯ä¸ªåç¨‹éƒ½éœ€è¦æœ‰è‡ªå·±çš„ç‹¬ç«‹æ ˆç©ºé—´ï¼Œé€šå¸¸ä½¿ç”¨å­—ç¬¦æ•°ç»„
```
chat stack[1024];
```

## 3. ä½¿ç”¨ getcontext è·å–å½“å‰ä¸Šä¸‹æ–‡æ¨¡æ¿
```
getcontext(ctx[0]);
```

getcontextæ“ä½œçš„æ„ä¹‰æ˜¯ä¸ºäº†è·å–ä¸€ä¸ª åˆæ³•çš„ã€å®Œæ•´çš„ä¸Šä¸‹æ–‡æ¨¡æ¿ ï¼Œä»¥ä¾¿å†æ¬¡åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œä»è€Œåˆ›å»ºä¸€ä¸ªæ–°çš„ã€å¯æ‰§è¡Œçš„åç¨‹ã€‚
ä¸ºä»€ä¹ˆéœ€è¦æ¨¡æ¿å‘¢ï¼Ÿå› ä¸ºä»0åˆ›å»ºä¸€ä¸ªæ­£ç¡®çš„ä¸Šä¸‹æ–‡åŠå…¶å¤æ‚ï¼Œéœ€è¦å¤„ç†åŒ…æ‹¬ CPUå¯„å­˜å™¨å½“å‰å€¼ã€ä¿¡å·æ©ç å’Œå…¶ä»–å¹³å°ç›¸å…³çŠ¶æ€ã€‚è€Œ getcontext è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå‡½æ•°ä¼šæŠŠ å½“å‰æ­£åœ¨è¿è¡Œçš„ã€åˆæ³•çš„ ä¸Šä¸‹æ–‡ä¿¡æ¯å®Œæ•´åœ°å¤åˆ¶ä¸€ä»½ã€‚

## 4. è®¾ç½®æ–°çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
è¿™ä¸€æ­¥éœ€è¦å¯¹ä¸Šä¸‹æ–‡ç»“æ„ä½“è¿›è¡Œä¿®æ”¹ï¼Œä¸ºå…¶æŒ‡å®šç‹¬ç«‹çš„æ ˆç©ºé—´å’Œå¤§å°ï¼ŒåŒæ—¶è®¾ç½®uc_linkï¼Œå®ƒæŒ‡å‘å½“è¿™ä¸ªæ–°çš„ä¸Šä¸‹æ–‡å‡½æ•°ç»“æŸåï¼Œç¨‹åºåº”è¯¥æ¢å¤åˆ°çš„ä¸Šä¸‹æ–‡ï¼ˆä¹Ÿæ˜¯ ucontext_tï¼‰
```
// æŒ‡å®šæ ˆ
ctx[0].uc_stack.ss_sp = stack1;
ctx[0].uc_stack.ss_size = sizeof(stack1);
// æŒ‡å®šåç»§ä¸Šä¸‹æ–‡
ctx[0].uc_link = &main_ctx;
```
## 5. åˆ›å»ºä¸Šä¸‹æ–‡
ä½¿ç”¨ makecontext å°†ä¸€ä¸ªå‡½æ•° func1 ä¸åˆšåˆšè®¾ç½®å¥½çš„ä¸Šä¸‹æ–‡å…³è”èµ·æ¥ï¼Œè¿™æ ·å½“è¿™ä¸ªä¸Šä¸‹æ–‡è¢«æ¿€æ´»çš„æ—¶å€™ï¼Œfunc1 å°±ä¼šè¢«æ‰§è¡Œ
```
makecontext(&ctx[0], func1, 0);
```

*void makecontext(ucontext_t *ucp, void (*func)(), int argc, ...);ï¼Œå‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å‚æ•°2ä¼ å…¥çš„å‡½æ•°çš„å‚æ•°ä¸ªæ•°*

## 6. åˆ‡æ¢ä¸Šä¸‹æ–‡
ä½¿ç”¨ swapcontext å‡½æ•°æ¥åˆ‡æ¢ï¼Œå‡½æ•°ä¼šä¿å­˜å½“å‰ä¸Šä¸‹æ–‡ï¼Œå¹¶æ¿€æ´»ä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡ï¼Œä»è€Œä½¿å¾—ç¨‹åºè·³è½¬åˆ°æ–°çš„ä¸Šä¸‹æ–‡æ‰€å…³è”çš„å‡½æ•°ä¸­æ‰§è¡Œã€‚

```
// ä» main_ctx åˆ‡æ¢åˆ° ctx[count%3]
swapcontext(&main_ctx, &ctx[count%3]);
```
**getcontextå’Œswapcontextéƒ½ä¿å­˜äº†ä¸Šä¸‹æ–‡ï¼Œä½†ä»–ä»¬ä¿å­˜çš„ç›®çš„å’Œæ—¶æœºå®Œå…¨ä¸åŒã€‚**
getcontextä¿å­˜çš„æ˜¯â€œæ¨¡æ¿â€ï¼Œswapcontextä¿å­˜çš„æ˜¯å½“å‰æ­£åœ¨è¿è¡Œçš„ä¸Šä¸‹æ–‡çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯â€œå¿«ç…§â€æˆ–â€œæ–­ç‚¹â€ã€‚

# ucontextå¦‚ä½•è§£å†³æå‡æ‰§è¡Œæ•ˆç‡
é¦–å…ˆè¦æ˜ç™½çš„æ˜¯ï¼Œåç¨‹çš„è°ƒåº¦æ˜¯å‘ç”Ÿåœ¨ç”¨æˆ·æ€çš„ï¼Œå®ƒéå¸¸ **è½»é‡å’Œå¿«é€Ÿ**ã€‚ä½†æ˜¯åƒread \ writeè¿™ç§IOæ“ä½œæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œä¼šé™·å…¥å†…æ ¸æ€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå†…æ ¸å‘ç°æ•°æ®æœªå°±ç»ªï¼Œå°±ä¼šæŒ‚èµ·æ•´ä¸ªOSçº¿ç¨‹ï¼Œè€Œä¸æ˜¯ä»…ä»…æŒ‚èµ·ç”¨æˆ·æ€çš„é‚£ä¸ªåç¨‹ã€‚
ä¸€æ—¦çº¿ç¨‹è¢«æŒ‚èµ·ï¼Œä¸ç®¡çº¿ç¨‹ä¸­è¿˜æœ‰å¤šå°‘ä¸ªIOæ˜¯å°±ç»ªçš„ï¼Œéƒ½æ— æ³•ç»§ç»­æ‰§è¡Œï¼

è€Œé€šè¿‡ å‡½æ•°é’©å­+ucontext ï¼Œå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åœ¨è¿›è¡ŒçœŸæ­£çš„ read \ write è°ƒç”¨å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥IOçš„å°±ç»ªçŠ¶æ€ï¼Œå¦‚æœæœªå°±ç»ªï¼Œå°±è®©å‡ºæ‰§è¡Œæƒï¼Œè¿™æ˜¯é€šè¿‡ swapcontext å®ç°çš„ã€‚

### ä¸‹é¢æ¥è¯´æ˜æ›´å¤šçš„å®ç°ç»†èŠ‚
1. é¦–æ¬¡å°è¯•
åœ¨é¦–æ¬¡è°ƒç”¨ read å‰ï¼Œå…ˆå°†æ–‡ä»¶æè¿°ç¬¦è®¾ç½®ä¸ºéé˜»å¡ï¼Œç„¶åè°ƒç”¨ã€‚
å¦‚æœæˆåŠŸè¯»åˆ°æ•°æ®ï¼Œé‚£è¿™æ¬¡è°ƒç”¨å’Œæ™®é€šçš„å‡½æ•°è°ƒç”¨æ— åŒºåˆ«ï¼›
å¦‚æœè¯»å–åˆ°EOFï¼Œä¹Ÿæ˜¯æ­£å¸¸æƒ…å†µï¼Œå’Œæ™®é€šè°ƒç”¨æ— åŒºåˆ«ï¼›
å¦‚æœè¿”å› EAGAIN æˆ– EWOULDBLOCK ï¼Œè¿™æ—¶å€™å°±æœ‰åŒºåˆ«äº†ã€‚
2. åˆ‡æ¢
å¦‚æœè¿”å› EAGAIN æˆ– EWOULDBLOCKï¼Œè¿™æ—¶å€™æˆ‘ä»¬ä¸ä¼šç»§ç»­è°ƒç”¨readï¼Œè€Œæ˜¯å°†è¿™ä¸ªfdæ³¨å†Œåˆ°è°ƒåº¦å™¨ç®¡ç†çš„epollå®ä¾‹ä¸­ã€‚
åŒæ—¶ï¼Œæˆ‘ä»¬ä¼šè®°å½•æ˜ å°„å…³ç³»(fd -> ucontext_t)ï¼Œå‘Šè¯‰è°ƒåº¦å™¨ï¼Œå¦‚æœè¿™ä¸ªfdå°±ç»ªäº†ï¼Œæˆ‘ä»¬åº”è¯¥å”¤é†’é‚£ä¸ªåç¨‹ã€‚
æœ€åï¼Œè°ƒç”¨ swapcontext å°†æ‰§è¡Œæƒäº¤è¿˜è°ƒåº¦å™¨ã€‚
3. æ¢å¤
æ­¤æ—¶ï¼Œè°ƒåº¦å™¨çš„ä¸»å¾ªç¯ä¼šé˜»å¡åœ¨ epoll_wait ä¸Šï¼Œå®ƒä¼šæŒç»­ç­‰å¾… IOäº‹ä»¶ã€‚
å½“æœ‰fdå°±ç»ªåï¼Œè°ƒåº¦å™¨ä¼šæ ¹æ®æ˜ å°„å…³ç³»æ‰¾åˆ°å¹¶æ¢å¤å¯¹åº”çš„åç¨‹ã€‚
å¯¹åº”çš„åç¨‹è¢«æ¢å¤åï¼Œä¼šå†æ¬¡è°ƒç”¨ read å‡½æ•°ï¼Œè¿™æ˜¯ä¸€æ¬¡å¿…ç„¶æˆåŠŸçš„è¯»å–ã€‚

**é€šè¿‡è¿™ä¸ªå®ç°ç»†èŠ‚çš„ä¾‹å­ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ä¸€çª¥åç¨‹çš„å¨åŠ›ï¼šé…åˆ å‡½æ•°é’©å­åŠepoll ä½¿ç”¨ï¼Œèƒ½å¤Ÿåˆ›å»ºä¸€ä¸ªéé˜»å¡çš„ã€å¼‚æ­¥çš„æ‰§è¡Œæ¨¡å‹ã€‚è¿™ä½¿å¾—å¼€å‘è€…å¯ä»¥ç”¨ç›´è§‚çš„æ–¹å¼å†™å‡ºå…·å¤‡æè‡´æ€§èƒ½çš„ä»£ç ã€‚**

# ç¤ºä¾‹
æœ€åè´´å‡ºæˆ‘å­¦ä¹ ä½¿ç”¨çš„ç¤ºä¾‹ä»£ç 
```
#define _GNU_SOURCE
#include <stdio.h>
#include <ucontext.h>
#include <string.h>

// å…¨å±€å˜é‡
ucontext_t ctx[3];      // ç”¨äºå­˜å‚¨ä¸‰ä¸ªåç¨‹çš„ä¸Šä¸‹æ–‡
ucontext_t main_ctx;    // ç”¨äºå­˜å‚¨ä¸»æµç¨‹ï¼ˆè°ƒåº¦å™¨ï¼‰çš„ä¸Šä¸‹æ–‡
int count = 0;          // åç¨‹å…±äº«çš„è®¡æ•°å™¨ï¼Œç”¨äºæ§åˆ¶è°ƒåº¦

/**
 * @brief åç¨‹1çš„æ‰§è¡Œä½“
 */
void func1(void) {
	while (count++ < 30) {
		printf("--> Coroutine 1: å¼€å§‹æ‰§è¡Œã€‚å…¨å±€ count = %d\n", count);
		printf("    Coroutine 1: å³å°†è®©å‡ºCPU...\n");

		// æ ¸å¿ƒæ“ä½œï¼šä¿å­˜å½“å‰åç¨‹çŠ¶æ€ï¼Œå¹¶åˆ‡æ¢å›ä¸»è°ƒåº¦å™¨
		swapcontext(&ctx[0], &main_ctx);

		// åç¨‹è¢«æ¢å¤åï¼Œå°†ä»è¿™é‡Œç»§ç»­æ‰§è¡Œ
		printf("<-- Coroutine 1: å·²è¢«æ¢å¤ï¼Œç»§ç»­æ‰§è¡Œã€‚\n\n");
	}
}

/**
 * @brief åç¨‹2çš„æ‰§è¡Œä½“
 */
void func2(void) {
	while (count++ < 30) {
		printf("--> Coroutine 2: å¼€å§‹æ‰§è¡Œã€‚å…¨å±€ count = %d\n", count);
		printf("    Coroutine 2: å³å°†è®©å‡ºCPU...\n");
		swapcontext(&ctx[1], &main_ctx);
		printf("<-- Coroutine 2: å·²è¢«æ¢å¤ï¼Œç»§ç»­æ‰§è¡Œã€‚\n\n");
	}
}

/**
 * @brief åç¨‹3çš„æ‰§è¡Œä½“
 */
void func3(void) {
	while (count++ < 30) {
		printf("--> Coroutine 3: å¼€å§‹æ‰§è¡Œã€‚å…¨å±€ count = %d\n", count);
		printf("    Coroutine 3: å³å°†è®©å‡ºCPU...\n");
		swapcontext(&ctx[2], &main_ctx);
		printf("<-- Coroutine 3: å·²è¢«æ¢å¤ï¼Œç»§ç»­æ‰§è¡Œã€‚\n\n");
	}
}

/**
 * @brief ä¸»å‡½æ•°ï¼šåˆå§‹åŒ–åç¨‹å¹¶å……å½“è°ƒåº¦å™¨
 */
int main() {
	// ä¸ºæ¯ä¸ªåç¨‹åˆ†é…ç‹¬ç«‹çš„æ ˆç©ºé—´
	char stack1[2048] = {0};
	char stack2[2048] = {0};
	char stack3[2048] = {0};

	/*
	 * åˆå§‹åŒ–åç¨‹1 (ctx[0])
	 * æµç¨‹: è·å–ä¸Šä¸‹æ–‡æ¨¡æ¿ -> è®¾ç½®ç‹¬ç«‹æ ˆ -> å…³è”åç»§ä¸Šä¸‹æ–‡ -> ç»‘å®šæ‰§è¡Œå‡½æ•°
	 */
	getcontext(&ctx[0]);
	ctx[0].uc_stack.ss_sp = stack1;
	ctx[0].uc_stack.ss_size = sizeof(stack1);
	ctx[0].uc_link = &main_ctx;
	makecontext(&ctx[0], func1, 0);

	// åˆå§‹åŒ–åç¨‹2 (ctx[1])
	getcontext(&ctx[1]);
	ctx[1].uc_stack.ss_sp = stack2;
	ctx[1].uc_stack.ss_size = sizeof(stack2);
	ctx[1].uc_link = &main_ctx;
	makecontext(&ctx[1], func2, 0);

	// åˆå§‹åŒ–åç¨‹3 (ctx[2])
	getcontext(&ctx[2]);
	ctx[2].uc_stack.ss_sp = stack3;
	ctx[2].uc_stack.ss_size = sizeof(stack3);
	ctx[2].uc_link = &main_ctx;
	makecontext(&ctx[2], func3, 0);

	printf("--- åç¨‹è°ƒåº¦å¼€å§‹ ---\n");
	
	// ä¸»å¾ªç¯å……å½“è°ƒåº¦å™¨ (Scheduler)ï¼Œè½®æµæ‰§è¡Œä¸‰ä¸ªåç¨‹
	while (count <= 30) {
		swapcontext(&main_ctx, &ctx[count%3]);
	}

	printf("\n--- åç¨‹è°ƒåº¦ç»“æŸ ---\n");
	
	return 0;
}
```

